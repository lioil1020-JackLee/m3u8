# M3U8 視頻下載器

一個功能強大的 M3U8 視頻下載工具，支持批量下載、靈活的集數選擇、並行處理和實時進度跟蹤。

## 功能特性

 **核心功能**
-  支持 M3U8 視頻流下載
-  智能 M3U8 URL 快速嗅探（~100ms/集）
-  並行下載支持（可配置並發數）
-  流水線架構（邊掃描邊下載邊合併邊檢查，充分利用硬件資源）
-  自動轉換為 MP4 格式（TS  MP4）

 **集數選擇**
-  支持多種靈活的集數選擇格式
  - `.` 或留空：下載全部集數（默認）
  - `1`：僅下載第1集
  - `1-10`：下載第1到第10集
  - `1,5,9,15`：下載指定的多個集數
  - `1-5,8,10-12`：混合範圍和單個集數

 **用戶界面**
- GUI 窗口配置（支持右鍵菜單粘貼）
- 支持 `.ico` 圖標自定義
- 命令行參數支持（適合自動化）

 **進度跟蹤**
- 實時集數狀態顯示（掃描中  排隊中  下載中  合併中  檢查中）
- 最終統計報告（成功/失敗統計）
- 詳細解析度報告

 **高級特性**
- 容器和 FLV 來源自動識別
- 集數重複名稱智能處理（例如：E153, E153-2）
- 特殊集數支持（總篇、劇場版等）
- 智能文件夾創建（自動創建輸出目錄）

## 系統要求

- **Python** 3.12 或更高版本
- **外部工具**（自動包含在發行版中）
  - `N_m3u8DL-RE.exe` - M3U8 下載器
  - `FFmpeg.exe` - 音視頻處理工具
  - `FFprobe.exe` - 視頻解析工具
  - `chromium` - 瀏覽器自動化（Playwright 自動下載）

## 安裝

### 方式 1：使用 Python 源代碼

```bash
# 克隆或下載項目
cd m3u8

# 安裝依賴
pip install -r requirements.txt

# 運行
python m3u8.py
```

### 方式 2：使用已編譯的 EXE（推薦）

直接運行 `m3u8.exe`，無需安裝 Python 或依賴。

## 使用方式

### GUI 模式（推薦用戶友好）

```bash
python m3u8.py
# 或
m3u8.exe
```

然後在彈出的窗口中：
1. 輸入目標頁面 URL
2. 選擇 FLV 來源（通常為 1，表示首個來源）
3. 選擇要下載的集數（支持靈活格式）
4. 選擇輸出資料夾
5. 點擊 "Start" 開始下載

### 命令行模式（適合自動化）

\\\ash
python m3u8.py \
    --url "https://example.com/video" \
    --flv-idx 1 \
    --start-ep "." \
    --out-dir "F:/videos" \
    --max-downloads 5 \
    --wait 1.5 \
    --no-ui

# 參數說明：
# --url              : 目標頁面 URL
# --flv-idx          : FLV 來源索引（默認：1）
# --start-ep         : 集數選擇（默認：. 即全部）
#                      支持格式：. 全部，1 僅第1集，1-10，1,5,9，1-5,8,10-12
# --out-dir          : 輸出資料夾（默認：當前目錄）
# --max-downloads    : 最大並發下載數（默認：5，建議 3-8）
# --wait             : M3U8 嗅探超時秒數（默認：2.0）
# --no-ui            : 不顯示 GUI，直接使用命令行參數
```

## 集數選擇示例

```bash
# 下載全部集數
--start-ep "."

# 只下載第1集
--start-ep "1"

# 下載第1到第20集
--start-ep "1-20"

# 下載第1, 5, 10, 15 集
--start-ep "1,5,10,15"

# 下載第1-5集、第10集、第15-20集
--start-ep "1-5,10,15-20"
```

## 輸出結果

下載完成後，將生成：
- `{show_name}.S{season}.E{episode}.mp4` - 最終 MP4 視頻文件
- `重新下載.txt` - 包含失敗和低分辨率（寬度 < 1920）集數列表的報告文件
- 自動刪除寬度 < 1920 的低分辨率視頻文件

## 工作流程

```
                   流水線架構說明                         

                                                         
  生產者 (主線程)                                        
   掃描集數1  M3U8 URL1  入隊                        
   掃描集數2  M3U8 URL2  入隊                        
   ...邊掃描邊入隊...                                  
                                                       
                                                       
    任務隊列                           
   URL1  URL2  ...                                 
                                      
                                                       
                                            
                消費者 (5個並發工作線程)             
     W1   W2   W3                                       
      下載  合併  檢查解析度                        
      下載  合併  檢查解析度                        
      下載  合併  檢查解析度                        
                                                       
                                                       
     生成 MP4 + 記錄解析度                              
                                                         
```

典型性能（基於網絡和硬件條件）：

| 操作 | 耗時 |
|------|------|
| M3U8 URL 嗅探 | ~100ms |
| 集數掃描（157集） | ~30-40 秒 |
| 並行下載（5個工作線程） | 取決於網速 |
| TS  MP4 合併 | 通常 5-30 秒/集 |

## 項目打包

## 項目打包

使用 uv 打包為獨立的 onedir 可執行文件：

```bash
# 打包為 onedir 格式
uv run pyinstaller --clean m3u8.spec

# 打包結果位於 dist/m3u8/ 文件夾
```

生成的 `dist/m3u8/` 文件夾包含：
- `m3u8.exe` - 主執行文件
- `exe/` - 外部工具目錄（ffmpeg, ffprobe, N_m3u8DL-RE）
- `lioil.ico` - 窗口圖標
- 完整的 Python 環境和依賴

## 故障排除

###  "找不到集數容器"
- 檢查 URL 是否正確且頁面已完全加載
- 網頁結構可能已更改，需要更新容器選擇器

###  M3U8 掃描失敗
- 增加 `--wait` 參數值（例如 3.0 秒）
- 檢查網絡連接
- 某些集數可能在源站不可用

###  FFmpeg 合併失敗
- 確保 `ffmpeg.exe` 在 `exe/` 目錄中
- 檢查硬盤空間是否充足

###  低分辨率或未知解析度
- 個別集數可能存儲格式特殊
- 仍可查看已下載的 MP4 文件

## 依賴項

詳見 `requirements.txt`：
- `playwright` - 瀏覽器自動化
- `urllib3` - HTTP 客戶端（無 SSL 警告）

## 許可證

個人用途專用工具。

## 貢獻

如有建議或發現 Bug，歡迎反饋。

---

**最後更新**: 2026 年 2 月

**版本**: 2.2 - 動態集數支持 + 強制關閉 + 自動清理 + 範圍驗證

### 新增功能（v2.2）

- ✅ 動態集數顯示：支持任意數量的集數，不限於 157 集
- ✅ 強制關閉功能：按 Ctrl+C 或終端 X 按鈕強制安全退出
- ✅ 自動清理：刪除臨時文件和低分辨率視頻（寬度 < 1920）
- ✅ 集數範圍驗證：輸入超出範圍時即時提示並退出
- ✅ 需要重新下載清單：終端機最後顯示失敗和低分辨率集數
- ✅ 報告文件優化：改為 `重新下載.txt`，更清晰的命名

### 版本歷史

**v2.1**: 流水線架構 + 靈活集數選擇
**v2.0**: 初始發布
